#!/bin/bash
# NAME
#     Help string generator for self-documenting make targets/recipes.
#
# SYNOPSIS
#     help: ## Displays this auto-generated usage message
#           mkhelp $(MAKEFILE_LIST) 
# 
# DESCRIPTION
#     Awk splits lines into target name and comment, prints them,
#     omitting any target names already printed on previous lines. column beautifies.
#
# ARGS
#     MAKEFILE_LIST
#       Make variable providing a whitespace-separated list of parsed Makefile(s).
#       https://www.gnu.org/software/make/manual/html_node/Special-Variables.html
#       (TODO: arg would be unnecessary if make vars exported to child processes,
#              but then script wouldn't be callable from outside a Makefile.)
#
# DEPENDENCIES
#     - GNU awk
#     - GNU grep
#     - GNU sed
#     - envsubst (GNU gettext package)
#     - column (util-linux package)
#
set -e
MAKEFILE_LIST="$1"
printf "Usage:  make [OPTION] ... [${GREEN}TARGET${RESET}] ...\n\n" \
    && grep -Eh '^[^#]*\s##\s' ${MAKEFILE_LIST} \
    | awk -v GREEN="${GREEN}" -v RESET="${RESET}" -F ":.*?## " ' \
    { \
        if (!target_name_already_printed) { target_name_already_printed=foo; } \
        if (target_name_already_printed == $1) { target=" "; } else { target=$1; } \
        printf "%s%s%s@%s\n", GREEN, target, RESET, $2; \
        target_name_already_printed = $1; \
    }' \
    | sed 's/\$(\([a-zA-Z_][a-zA-Z_0-9]*\))/${\1}/g' \
    | envsubst \
    | column -t -s@ -o'  ' --keep-empty-lines \
        --table-columns TARGET,DESCRIPTION \
        --table-right 1 \
        --table-wrap 2

